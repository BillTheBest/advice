<!DOCTYPE html>

<html>
<head>
  <title>advice.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>advice.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 ADVICE
 ====================
 */</span>
<span class="hljs-comment">/*
 * @version 0.2
 *
 * @fileOverview Based on the Advice functional mixin library by Angus Croll. Adds functional mixins to an object.
 * Advice offers a number of ways to modify methods and properties on an object.  It makes it possible to reuse code and compose together functionality to create an object behavior.
 * Copyright 2015 Dataminr
 * Licensed under The MIT License
 * http://opensource.org/licenses/MIT
 * work derived from https://github.com/twitter/flight/blob/master/lib/advice.js

 *
 */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(root, factory)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
        define([<span class="hljs-string">'mutation'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
            root.Advice = factory(root, _);
            <span class="hljs-keyword">return</span> root.Advice;
        });
    } <span class="hljs-keyword">else</span> {
        root.Advice = factory(root, root._);
    }
}(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(root, _)</span> </span>{

    <span class="hljs-comment">/**
     * adds mixins to an object
     */</span>
    <span class="hljs-keyword">var</span> mixInto = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mixins, options)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>used to saved applied mixins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.mixedIn = _.clone(<span class="hljs-keyword">this</span>.mixedIn) || [];
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.__super__
            || <span class="hljs-keyword">this</span>.mixedOptions == <span class="hljs-keyword">this</span>.__super__.constructor.mixedOptions) {
            <span class="hljs-keyword">this</span>.mixedOptions = _.clone(<span class="hljs-keyword">this</span>.mixedOptions) || {};
        }
        _.extend(<span class="hljs-keyword">this</span>.mixedOptions, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>if only one passed in make it an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!_.isArray(mixins))
            mixins = [mixins];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if an array then run each mixin and save to mixedIn array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        mixins = _(mixins).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mixin)</span> </span>{
            <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">Boolean</span>(mixin)) <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Missing mixin at '</span>, <span class="hljs-keyword">this</span>.prototype.className, <span class="hljs-keyword">this</span>.prototype);
            <span class="hljs-keyword">if</span> (!_.isFunction(mixin)) <span class="hljs-keyword">return</span> mixin;
            <span class="hljs-keyword">if</span> (!_.contains(<span class="hljs-keyword">this</span>.mixedIn, mixin)) {
                <span class="hljs-keyword">this</span>.mixedIn.push(mixin);
                <span class="hljs-keyword">if</span>(mixin) <span class="hljs-keyword">return</span> mixin.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.mixedOptions);
            }
        }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>if we have an object (can be returned by functions) - use them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _(mixins).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mixin)</span> </span>{

            <span class="hljs-keyword">if</span> (!mixin) <span class="hljs-keyword">return</span>;

            mixin = _.clone(mixin);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>call the reserved keywords</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _([
                <span class="hljs-string">'mixin'</span>,
                <span class="hljs-string">'around'</span>,
                <span class="hljs-string">'after'</span>,
                <span class="hljs-string">'before'</span>,
                <span class="hljs-string">'clobber'</span>,
                <span class="hljs-string">'addToObj'</span>,
                <span class="hljs-string">'setDefaults'</span>
            ]).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                <span class="hljs-keyword">if</span> (mixin[key]) {
                    <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'mixin'</span>)
                        <span class="hljs-keyword">this</span>[key](mixin[key], <span class="hljs-keyword">this</span>.mixedOptions);
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-keyword">this</span>[key](mixin[key]);
                    <span class="hljs-keyword">delete</span> mixin[key];
                }
            }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>on the remaining keywords, guess how to add them in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _.each(_.keys(mixin), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>if it’s a function then put it after</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (_.isFunction(mixin[key])) {
                    <span class="hljs-keyword">this</span>.after(key, mixin[key]);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>if it’s an object then add it to any existing one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isObject(mixin[key]) &amp;&amp; !_.isArray(mixin[key])) {
                    <span class="hljs-keyword">var</span> obj = {};
                    obj[key] = mixin[key];
                    <span class="hljs-keyword">this</span>.addToObj(obj);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>else change the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.clobber(key, mixin[key]);
                }
            }, <span class="hljs-keyword">this</span>);
        }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">var</span> addMixin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mixin, options)</span> </span>{
        mixin.call(<span class="hljs-keyword">this</span>, options);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">var</span> hasMixin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mixin)</span> </span>{
        <span class="hljs-keyword">var</span> mixins = <span class="hljs-keyword">this</span>.mixedIn || <span class="hljs-keyword">this</span>.constructor.mixedIn;
        <span class="hljs-keyword">return</span> _.contains(mixins, mixin);
    };
    <span class="hljs-keyword">var</span> Advice = {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>calls the wrapped function with base functions as first argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        around: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, wrapped)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);
                <span class="hljs-keyword">return</span> wrapped.apply(<span class="hljs-keyword">this</span>, [_.bind(base, <span class="hljs-keyword">this</span>)].concat(args));
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>will call the new function before the old one with same arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        before: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, before)</span> </span>{
            <span class="hljs-keyword">return</span> Advice.around(base, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>),
                    orig = args.shift(),
                    beforeFn;

                beforeFn = (<span class="hljs-keyword">typeof</span> before == <span class="hljs-string">'function'</span>) ? before : before.obj[before.fnName];
                beforeFn.apply(<span class="hljs-keyword">this</span>, args);
                <span class="hljs-keyword">return</span> (orig).apply(<span class="hljs-keyword">this</span>, args);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>will call the new function after the old one with same arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        after: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, after)</span> </span>{
            <span class="hljs-keyword">return</span> Advice.around(base, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>),
                    orig = args.shift(),
                    afterFn;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>this is a separate statement for debugging purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> res = (orig.unbound || orig).apply(<span class="hljs-keyword">this</span>, args);

                afterFn = (<span class="hljs-keyword">typeof</span> after == <span class="hljs-string">'function'</span>) ? after : after.obj[after.fnName];
                <span class="hljs-keyword">var</span> result = afterFn.apply(<span class="hljs-keyword">this</span>, args);
                <span class="hljs-keyword">return</span> result;
            });
        },

        <span class="hljs-comment">/**
         * if it exists then overwrite
         */</span>
        clobber: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, key, value)</span> </span>{
            <span class="hljs-keyword">var</span> extBase = base;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> extBase == <span class="hljs-string">'function'</span>)
                extBase = base.prototype;
            <span class="hljs-keyword">if</span> (_.isString(key)) {
                <span class="hljs-keyword">var</span> temp = key;
                key = {};
                key[temp] = value;
            }
            _.extend(extBase, key);
            <span class="hljs-keyword">return</span> base;
        },

        <span class="hljs-comment">/**
         * will add values to an existing object (good for 'events')
         */</span>
        addToObj: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, obj)</span> </span>{
            <span class="hljs-keyword">var</span> extBase = base;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> extBase == <span class="hljs-string">'function'</span>)
                extBase = base.prototype;
            _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> </span>{
                extBase[key] = _.extendWith(_.clone(Advice.findVal(extBase, key)) || {}, val);
            });
            <span class="hljs-keyword">return</span> base;
        },

        <span class="hljs-comment">/**
         * will set only if doesn't exist
         */</span>
        setDefaults: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base, obj)</span> </span>{
            <span class="hljs-keyword">var</span> extBase = base;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> extBase == <span class="hljs-string">'function'</span>)
                extBase = base.prototype;
            _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> </span>{
                <span class="hljs-keyword">if</span> (!Advice.findVal(extBase, key))
                    extBase[key] = val;
            });
            <span class="hljs-keyword">return</span> base;
        },

        <span class="hljs-comment">/**
         * find a value in a prototype chain
         */</span>
        findVal: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, name)</span> </span>{
            <span class="hljs-keyword">while</span> (!obj[name] &amp;&amp; obj.prototype)
                obj = obj.prototype;
            <span class="hljs-keyword">return</span> obj[name];
        },

        <span class="hljs-comment">/**
         * adds advice functions to an object
         */</span>
        addAdvice: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>adds before, after and around</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="hljs-string">'before'</span>, <span class="hljs-string">'after'</span>, <span class="hljs-string">'around'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
                obj[m] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, fn)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>if an object is passed in then split that in to individual calls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> method == <span class="hljs-string">'object'</span>) {
                        _.each(_.keys(method), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                            <span class="hljs-keyword">this</span>[m](key, method[key]);
                        }, <span class="hljs-keyword">this</span>);
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>functions should go on a prototype if a constructor passed in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> base = <span class="hljs-keyword">this</span>;
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> base == <span class="hljs-string">'function'</span>)
                        base = <span class="hljs-keyword">this</span>.prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>find original function in the prototype chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> orig = Advice.findVal(base, method);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>use an identity function if none found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> orig != <span class="hljs-string">'function'</span>) {
                        <span class="hljs-keyword">if</span> (m != <span class="hljs-string">'around'</span>) {
                            base[method] = fn;
                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
                        }
                        orig = _.identity;
                    }
                    base[method] = Advice[m](orig, fn);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
                };
            });

            <span class="hljs-keyword">var</span> callWithThis = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{
                <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>].concat(_.toArray(<span class="hljs-built_in">arguments</span>).slice(<span class="hljs-number">1</span>)));
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>add in other functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            obj.addMixin = addMixin;
            obj.mixin = mixInto;
            obj.hasMixin = obj.prototype.hasMixin = hasMixin;
            obj.addToObj = _.partial(callWithThis, Advice.addToObj);
            obj.setDefaults = _.partial(callWithThis, Advice.setDefaults);
            obj.findVal = _.partial(callWithThis, Advice.findVal);
            obj.clobber = _.partial(callWithThis, Advice.clobber);

        }
    };
    <span class="hljs-keyword">return</span> Advice;

}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
